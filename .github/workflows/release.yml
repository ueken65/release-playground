name: Create Release on Tag Push to Main

on:
  push:
    branches:
      - main

jobs:
  create_release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: git config --global --add safe.directory /github/workspace

      - name: Get latest tag
        id: get_tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0)
          echo "LATEST_TAG=${LATEST_TAG}" >> $GITHUB_ENV

      - name: Check if release exists
        id: check_release
        run: |
          if gh release view ${{ env.LATEST_TAG }} >/dev/null 2>&1; then
            echo "Release already exists for tag ${{ env.LATEST_TAG }}"
            exit 0
          else
            echo "No release found for tag ${{ env.LATEST_TAG }}. A new release will be created."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install GitHub CLI
        run: sudo apt-get install -y gh

      - name: Create release
        if: steps.check_release.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LATEST_TAG: ${{ env.LATEST_TAG }}
        run: |
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
          gh release create $LATEST_TAG --generate-notes --title "$LATEST_TAG" --notes ""
